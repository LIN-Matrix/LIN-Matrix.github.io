
## 🧱 模块设计概述

- 实现类 Unix 系统调用语义（如 `socket`, `bind`, `listen`, `connect` 等）。
- 基于 `lose_net_stack` 虚拟网络栈实现 TCP/UDP 功能。
- 网络服务通过 `NET_SERVER` 统一协调，所有 socket 实例共享。

---

## 🔌 NetInterface 与 NetMod 实现

```rust
impl NetInterface for NetMod {
    fn send(data: &[u8]) { ... }
    fn local_mac_address() -> MacAddress { ... }
}
```

- 定义用于发送数据和获取 MAC 地址的接口。
- 该模块通过 `get_net_device(0)` 访问虚拟网卡。
- `NET_SERVER` 是 `NetServer<NetMod>` 的全局惰性实例，管理 TCP/UDP 连接。

---

## 🧵 Socket 创建与双工通信

### `sys_socket`

- 分配文件描述符（FD）并为用户创建 socket 对象。
- 根据 `net_type` (如 `STEAM`, `DGRAME`) 初始化协议栈。

### `sys_socket_pair`

- 创建一对双工 socket，FD 写入用户空间 `UserRef` 数组。

---

## 📡 套接字绑定与监听

### `sys_bind`

- 将给定的 `SocketAddrIn` 绑定到 socket。
- 自动检测 `NetType`，尝试端口重用（`reuse`）逻辑。
- 使用 `socket.inner.bind(local)` 与虚拟栈注册本地监听地址。

### `sys_listen`

- 将 socket 置为监听状态。
- 仅对 `NetType::STEAM`（类似 TCP）有效。

---

## 📥 连接与接收

### `sys_accept` / `sys_accept4`

- 阻塞地从监听 socket 接收连接，生成新 socket 并分配 FD。
- `accept4` 支持传递 `OpenFlags` 设置（如非阻塞）。

### `sys_connect`

- 异步连接远程地址。
- 使用循环与 `yield_now()` 实现阻塞等待连接建立。

---

## ✉️ 数据收发接口

### `sys_sendto`

- 若未绑定，则自动绑定临时端口（127.0.0.1:0）。
- 解析目标地址并通过 `inner.sendto` 发送数据。

### `sys_recvfrom`

- 阻塞接收数据，写入用户缓冲区。
- 若目标 `UserRef<SocketAddrIn>` 有效，将源地址信息写回。

---

## ⚙️ 套接字选项支持

### `sys_setsockopt`

- 当前返回 `Ok(0)`，未做实际配置，避免某些游戏死锁。

### `sys_getsockopt`

- 支持查询发送缓存、接收缓存等参数（如 `SO_RCVBUF = 0x8`）。

---

## 🧭 地址查询接口

### `sys_getsockname`

- 获取本地绑定地址（IP + port）。

### `sys_getpeername`

- 获取对端地址（连接建立后有效）。

---

## 🧯 套接字关闭

### `sys_shutdown`

- 调用 socket 的 `close()` 方法释放资源。

---

## 🧩 架构特性总结

| 功能            | 支持情况         | 说明 |
|-----------------|------------------|------|
| TCP/UDP 支持    | ✅ 基于 `NetType` | 支持 STEAM / DGRAME 类型 |
| 非阻塞 I/O      | ✅ via `OpenFlags` | 检查 `O_NONBLOCK` 标志 |
| 信号中断支持    | ✅                | 使用 `signal.has_signal()` 检查 |
| 地址翻译        | ✅ `SocketAddrIn` 映射 | 网络字节序 to 主机字节序处理 |
| socket 复用     | ✅ reuse(port)    | 避免绑定冲突 |
| 内核 FD 管理    | ✅ `alloc_fd` / `set_fd` | 用户态视角透明 |

---

## 📌 可改进建议

- `sys_setsockopt` 和 `sys_getsockopt` 可拓展支持更多参数。
- socket 的生命周期应考虑加入引用计数或连接状态检查。
- 支持 IPv6 与更复杂的协议选项，如 TCP_NODELAY。

